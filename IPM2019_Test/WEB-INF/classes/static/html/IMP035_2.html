<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Usage Analysis</title>

    <!-- We use google fonts for many of the examples, but they are not necessary -->
    <link href='../styles/googleapis_Roboto.css' rel='stylesheet' type='text/css'>

    <!-- Test container style sheets -->
    <link rel="stylesheet" href="../styles/examples.css">

    <!-- Vizuly specific style sheets -->
    <link rel="stylesheet" href="../styles/vizuly.css">
    <link rel="stylesheet" href="../styles/vizuly_weightedtree.css">

    <!-- Supporting test container files:  Vizuly does NOT rely on these -->
    <link href="../styles/googleapis_materialicon.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/cssmenu.css">
    <script type="text/javascript" src="../JScript/jquery-2.1.1.min.js"></script>
    <script src="../JScript/cssmenu.js"></script>

    <!-- D3.js ... of course! -->
    <script src="../JScript/d3.min.js"></script>

    <!-- debug source scripts: end -->
<style>
#header_div
{
float: left;
margin-top: 5px;
}
#lstBox1, #lstBox2 {
	width: 200px;
	height: 100px;
	padding: 0;
	margin-top: 2px;
	font-size:12px;
}
#lstBox2{
	margin-left: 40px;
	float: left;
}
#btnAllRight {
	width: 30px;
    margin-left: 30px;
	margin-top: 10px;
}
#btnRight,#btnLeft,#btnAllLeft {
	width: 30px;
    margin-left: 30px;
	margin-top: 5px;
}
#CompareTest_lbl1,#CompareTest_lbl{
	width: 150px;
	height: 150px;
	padding: 0;
	font-weight: bold;
}
#CompareTest_lbl1{
	margin-left: 40px;
}

.btn { 
    background: #428bca;
    border: 2px solid #428bca;
    border-radius: 2px;
    color: white;
    cursor: pointer;
    width: 130px;
    height: 25px;	
   	line-height: 10px;
}

.btn_compare {
	background-color: #428bca;
	color:#ffffff;
	font-family:Arial;
	font-size:12px;
	margin-left:16%;
	margin-top: 2%;
}

#Tbl_Compare {
  border: 1px solid #1C6EA4;
  width: 75%;
  text-align: left;
  border-collapse: collapse;
  border-radius: 10px;
}
#Tbl_Compare td, #Tbl_Compare th {
  border: 1px solid #AAAAAA;
  padding: 3px 2px;
}
#Tbl_Compare th {
  text-align: center;
}
#Tbl_Compare tbody td {
  font-size: 14px;
}
#Tbl_Compare tr:nth-child(even) {
  background: #f2f2f2;
}

</style>


    <script src="../JScript/vizuly_core.min.js"></script>
	<script src="../JScript/vizuly_weightedtree.min.js"></script>

    <script src="../JScript/RCAold.js"></script>

</head>

<body onload="getTradeValue()">


<div id='cssmenu'>
    <ul class="main-menu">
        <li class='active'>
            <a><span>Display</span><br><span class="setting"></span></a>
            <!--ul class="options"-->
                <li id="currentDisplay"></li>
                <!--li item_value="1000,1000"><a>1000px - 1000px</a></li-->
                <!--li item_value="800,600"><a>800px - 600px</a></li-->
                <!--li item_value="375,667"><a>375px - 667px</a></li-->
                <!--li item_value="320,568"><a>320px - 568px</a></li-->
            <!--/ul-->

        </li>

        <!-- <li class='active'><a><span>Theme </span><br><span class="setting"></span></a> -->
            <!-- <ul class="options" callback="changeSkin"> -->
                <!-- <li item_value="None"><a>None</a></li> -->
                <!-- <li item_value="Axiis" class="selected"><a>Axiis</a></li> -->
            <!-- </ul> -->
        <!-- </li> -->
        <!-- <li class='active'><a><span class="label">Data </span><br><span class="setting"></span></a> -->
          <!-- <ul class="options" callback="changeData"> -->
                <!-- <li item_value="0" class="selected"><a>Failures</a></li> -->
                <!-- <li item_value="1"><a>State</a></li> -->
                <!-- <li item_value="2"><a>Local</a></li> -->
            <!-- </ul> -->
        <!-- </li> -->
    </ul>
</div>

<!-- Our main content container-->
<!-- <div class="container" style="width:100%"> -->

<!--  <div id="wrapper">
<div class="fixed-header">
	   <label style="color:#e25c09;">Deviation Across </label><label>WorkStreams</label>
	   <!-- </div>

	   </div> </br></br>
	   </div> -->
	   <a href="javascript:clickDownload();" id ="Download_Usageanalysis" ><img src="../images/Download.png"  style="color:black; width: 48px; height: 30px; margin-top: 20px; margin-right: 30px; float: right;" ></a>
	   <label id="trade_lbl" style="margin-left: 20%; margin-top: 10px;">Trade Value: </label>
	   <select id="slt_trade" onchange="bindlist1details()" style="border-radius: 10px;width: 150px;border: solid; border-width: thin; padding-left: 5px;">
		</select><br/>
	   
	<div id="header_div" style="margin-left: 20%;">
		<label id="CompareTest_lbl">Trade characteristics: </label></br>
		<select multiple="multiple" id='lstBox1' ></select>
	</div>
	<div id="header_div"><!--class="subject-info-arrows text-center"-->
		<input type='button' id='btnAllRight' value='>>' class="btn btn-default" /><br />
		<input type='button' id='btnRight' value='>' class="btn btn-default" /><br />
		<input type='button' id='btnLeft' value='<' class="btn btn-default" /><br />
		<input type='button' id='btnAllLeft' value='<<' class="btn btn-default" />
	</div>
	<div id="header_div">
	  <label id="CompareTest_lbl1">Trade Position: </label></br>
	  <select multiple="multiple" id='lstBox2' ></select></br>
	  <label style="float: left; font-size: 12px; margin-left: 40px; margin-top: 5px; width: 250px;">The above characteristics order will position the top node as parent for the immediate next node</label></br>
	</div>
	<div style="width:100%; float: left; margin-top: -20px; margin-left: 16%">
	<input type="button" value="Master data" id ="master_bf" class="btn_compare" onclick="masterCsv();">
	<input type="button" value="Rearrange" id ="save_bf" class="btn_compare" style="margin-left: 2%" onclick="readMasterCSV();">
	</div><br/><br/>
	<label style="float: left; font-size: 16px; font-weight:bold; text-decoration: underline; margin-left: 35%; margin-top: 10px; width: 250px;" id="Trade_lbl"></label></br>
    <div id="viz_container">

	<br/>
	<!-- <input type="radio" style="margin-left: 35%;" id="wk_RCA" onclick="radio_RCA(this);" name="Deviation" value="0" checked /><i id="check_box1" >Deviation Across WorkStreams</i>
		<input type="radio" id="ly_RCA" onclick="radio_RCA(this);" name="Deviation" value="1"/><i id="check_box2" >Deviation Across Layers</i> -->
 <!-- <a href="javascript:clickDownload();" onclick="clickDownload()" id ="Download_Workstream" ><img src="../../images/Download.png"  style="color:black; width: 48px; height: 30px; margin-top: 20px; margin-right: 30px; float: right;" ></a>
 -->
  <br/>
	</div>
    </div>

    <!-- </div> -->
	<div class="sticky">
<div class="fixed-footer"></div>
</div>

<script>

	$(function() {
		$('#btnRight').click(function(e) {
			var selectedOpts = $('#lstBox1 option:selected');
			if(selectedOpts.length == 0) {
				alert("Select atleast one charecteristic from left to move.");
				e.preventDefault();
			}
			$('#lstBox2').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnAllRight').click(function(e) {
			var selectedOpts = $('#lstBox1 option');
			if(selectedOpts.length == 0) {
				alert("Moved already from left to right.");
				e.preventDefault();
			}
			$('#lstBox2').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnLeft').click(function(e) {
			var selectedOpts = $('#lstBox2 option:selected');
			if(selectedOpts.length == 0) {
				alert("Select atleast one charecteristic from right to move.");
				e.preventDefault();
			}
			$('#lstBox1').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnAllLeft').click(function(e) {
			var selectedOpts = $('#lstBox2 option');
			if(selectedOpts.length == 0) {
				alert("Moved already from right to left..");
				e.preventDefault();
			}
			$('#lstBox1').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#save_bf').click(function(e) {
			var selectedOpts = $('#lstBox2 option');
			if(selectedOpts.length == 0) {
				alert("Move charecteristic into trade position to do rearrange");
				e.preventDefault();
			}			
		});
	});
	
	var allText =[];
    var allTextLines = [];
    var Lines = [];
	var tradeconst = ""
	
	var CSVToArray = function CSVToArray(data) {
		var delimiter =
			arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ",";
		var omitFirstRow =
			arguments.length > 2 && arguments[2] !== undefined
				? arguments[2]
				: false;
	 
		return data
			.slice(omitFirstRow ? data.indexOf("\n") + 1 : 0)
			.split("\n")
			.map(function(v) {
				return v.split(delimiter);
			});
	};
	
	var csvArray = []
	var response_val = "";
	function getTradeValue()
	{
		var txtFile = new XMLHttpRequest();
		var allTextLines = ""
		var i=0;
		var header_val = []
		var tradeval_arr = []
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");	
		txtFile.open("GET", "../html/Reports/"+foldername+"/IMP035_usage.csv", true);
		//txtFile.open("GET", "../html/Reports/murexold.csv", true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				allText = this.responseText;
				response_val = allText;
				document.getElementById("Trade_lbl").innerHTML = "Master Data";
				/*if(i == 0)
				{
					header_val = (allText.split('\n'))[0].split(',');
					for(var j=5; j < header_val.length; j++)
					{
						var opt = document.createElement("option");
						opt.text = header_val[j];
						document.getElementById("lstBox1").options.add(opt);
					}
					i = i+1;*/
					res_txt = allText.split('\n');
					for(var res_i=1; res_i < res_txt.length; res_i++)
					{
						val_arr = res_txt[res_i].split(',');
						tradeval_arr.push(val_arr[3]);
					}					
				//}
				//console.log(tradevalue);
				const uniqueTradeValue = Array.from(new Set(tradeval_arr));
				for (var uni_i = 0; uni_i < uniqueTradeValue.length; uni_i++) {
					if(uniqueTradeValue[uni_i] != undefined && uniqueTradeValue[uni_i] != "")
					{
					var opt = document.createElement("option");
					opt.text = uniqueTradeValue[uni_i];
					document.getElementById("slt_trade").options.add(opt);
					}
				}
				csvArray = CSVToArray(allText);
				bindlist1details();
			}
			
		};
		txtFile.send();
	}
	
	function bindlist1details()
	{ 
		var list_val = document.getElementById("lstBox1")
		var length = list_val.options.length;
		for (i = length-1; i >= 0; i--) {
		  list_val.options[i] = null;
		}
		var list2_val = document.getElementById("lstBox2")
		var length2 = list2_val.options.length;
		for (j = length2-1; j >= 0; j--) {
		  list2_val.options[j] = null;
		}
		res_txt = response_val.split('\n');
		var sel_box1 = []
		var sel_val = document.createElement("slt_trade")
		for(var res_i=1; res_i < res_txt.length; res_i++)
		{
			val_arr = res_txt[res_i].split(',');
			if(val_arr[3] == $("#slt_trade option:selected").text())
			{
				tradeconst = val_arr[0] +","+ val_arr[1] +","+ val_arr[2] +","+ val_arr[3] +","+ val_arr[4]
				if(val_arr[4].trim() == "Trade Charcteristics")
				{
					sel_box1.push(val_arr[5]);
				}
			}
		}	
		var unique = sel_box1.filter((v, i, a) => a.indexOf(v) === i);
		for(var j=0; j < unique.length; j++)
		{
			var opt = document.createElement("option");
			opt.text = unique[j];
			document.getElementById("lstBox1").options.add(opt);
		}
		console.log(unique);
	}
		
	
	function masterCsv()
	{	
		document.getElementById("Trade_lbl").innerHTML = "Master Data";
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");
		loadData("../html/Reports/"+foldername+"/IMP035_usage.csv");
	}
	
	function readMasterCSV()
	{
		var txtFile = new XMLHttpRequest();
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");
		txtFile.open("GET", "../html/Reports/"+foldername+"/murex_master.csv", true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				csvArray = CSVToArray(this.responseText);
				createCsv();
			}
			
		};
		txtFile.send();
	}
	
	/*function createCsv()
	{
		var x = document.getElementById("lstBox2");
		var csv_val = [];
		var down_csv_val = [];
		var root_hdr_val = ""
		if(x.length > 0)
		{		
			console.log(csvArray);
			//var tradeconst = "Trade,IRD,IRS,IRS,Trade Characteristics"
			csv_val.push(tradeconst)
			down_csv_val.push(tradeconst)
			for (i = 0; i < x.length; i++) { 
				for( let hdr_i = 0; hdr_i < csvArray[0].length; hdr_i++ ){
					  if( x.options[i].text == csvArray[0][hdr_i]){
						hdr_value = hdr_i;	
					  }
					  if(i>=1)
					  {
							if( x.options[i-1].text == csvArray[0][hdr_i]){
								root_hdr_val = hdr_i;
							}
						}
					}
				var unique = [];
				var counts = {};
					var distinct = [];
					unique[csvArray[5]] = 1;
					for( let csv_i = 0; csv_i < csvArray.length; csv_i++ ){
						if(csvArray[csv_i][hdr_value] != "" && csvArray[csv_i][3] == $("#slt_trade option:selected").text())
						{
							if(i >= 1){
								if(csvArray[csv_i][root_hdr_val] != "")
								{
									counts[csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][hdr_value]] || 0);
									if( !unique[csvArray[csv_i][hdr_value]]){
										distinct.push(csvArray[csv_i][hdr_value]);
										unique[csvArray[csv_i][hdr_value]] = 1;
									}
								}
							}
							else{
								counts[csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][hdr_value]] || 0);
								if( !unique[csvArray[csv_i][hdr_value]]){
									distinct.push(csvArray[csv_i][hdr_value]);
									unique[csvArray[csv_i][hdr_value]] = 1;
								}
							}
						}
					}
					console.log(distinct);
					console.log(counts);
					console.log(unique);
					var trade_rearr=[]
					var trade_rearr_agg=[]
					for(var dis_i=0; dis_i < distinct.length; dis_i++)
					{		
						if(distinct[dis_i] != undefined)
						{
						for(var csv_val_arr=0; csv_val_arr < csv_val.length; csv_val_arr++)
						{
							if(i == (x.length -1))
							{							
								trade_val = csv_val[csv_val_arr] + "," + x.options[i].text + "," + distinct[dis_i] + "," + counts[distinct[dis_i]];	
							}
							else{							
								trade_val = csv_val[csv_val_arr] + "," + x.options[i].text + "," + distinct[dis_i];	
							}		
							trade_val_arr = csv_val[csv_val_arr] + "," + x.options[i].text + "," + distinct[dis_i] + "," + counts[distinct[dis_i]];trade_rearr.push(trade_val);
						}
						for(var down_csv_val_arr=0; down_csv_val_arr < down_csv_val.length; down_csv_val_arr++)
						{
							trade_val_arr = down_csv_val[down_csv_val_arr] + "," + x.options[i].text + "," + distinct[dis_i] + "," + counts[distinct[dis_i]];
							console.log(trade_val_arr);
							trade_rearr_agg.push(trade_val_arr);
						}
						}
					}
					csv_val = trade_rearr;
					down_csv_val = trade_rearr_agg;
					console.log(csv_val);
			}
			if(x.length == 1)
			{
				csv_val.splice(0,0,"Category,Level1,Level2,Level3,Level4,Level5,Level6,Failures");
				down_csv_val.splice(0,0,"Category,Family,Group,Typology,Characterictics,"+x.options[0].text+","+x.options[0].text+" Value");
			}
			else if(x.length == 2)
			{
				csv_val.splice(0,0,"Category,Level1,Level2,Level3,Level4,Level5,Level6,Level7,Level8,Failures");
				down_csv_val.splice(0,0,"Category,Family,Group,Typology,Characterictics,"+x.options[0].text+","+x.options[0].text+" Value,"+x.options[1].text+","+x.options[1].text+" Value");
			}
			else if(x.length == 3)
			{
				csv_val.splice(0,0,"Category,Level1,Level2,Level3,Level4,Level5,Level6,Level7,Level8,Level9,Level10,Failures");
				down_csv_val.splice(0,0,"Category,Family,Group,Typology,Characterictics,"+x.options[0].text+","+x.options[0].text+" Value,"+x.options[1].text+","+x.options[1].text+" Value,"+x.options[2].text+","+x.options[2].text+" Value");
			}
			else if(x.length == 4)
			{
				csv_val.splice(0,0,"Category,Level1,Level2,Level3,Level4,Level5,Level6,Level7,Level8,Level9,Level10,Level11,Level12,Failures");
				down_csv_val.splice(0,0,"Category,Family,Group,Typology,Characterictics,"+x.options[0].text+","+x.options[0].text+" Value,"+x.options[1].text+","+x.options[1].text+" Value,"+x.options[2].text+","+x.options[2].text+" Value,"+x.options[3].text+","+x.options[3].text+" Value");
			}
			let csvContent="";
			csv_val.forEach(function(rowArray) {
				csvContent += rowArray.valueOf().replace (/"/g,'') + "\n";
			});
			let down_csvContent="";
			down_csv_val.forEach(function(down_rowArray) {
				down_csvContent += down_rowArray.valueOf().replace (/"/g,'') + "\n";
			});
			console.log(csvContent.replace (/"/g,''));
			rearrange(csvContent.replace (/"/g,''), down_csvContent.replace (/"/g,''));
			//loadData("../html/Reports/murexold_281020200700.csv");
		}
		
	}*/
	
	function createCsv()
	{
		var x = document.getElementById("lstBox2");
		var csv_val = [];
		var down_csv_val = [];
		var root_hdr_val = "";
		var old_distinct_val = "";
		if(x.length > 0)
		{		
			csv_val.push(tradeconst)
			down_csv_val.push(tradeconst)
			for (i = 0; i < x.length; i++) { 
				for( let hdr_i = 0; hdr_i < csvArray[0].length; hdr_i++ ){
					if( x.options[i].text.trim() === csvArray[0][hdr_i].trim()){
						hdr_value = hdr_i;	
					}
					if(i>=1)
					{
						if( x.options[i-1].text.trim() === csvArray[0][hdr_i].trim()){
							root_hdr_val = hdr_i;
						}
					}
				}
				var unique = [];
				var counts = {};
				var distinct = [];
				unique[csvArray[5]] = 1;
				for( let csv_i = 0; csv_i < csvArray.length; csv_i++ ){
					if(csvArray[csv_i][hdr_value] != "" && csvArray[csv_i][3] === $("#slt_trade option:selected").text())
					{
						if(i >= 1){
							if(csvArray[csv_i][root_hdr_val] != "")
							{
								counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] || 0);
								if( !unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]]){
									distinct.push(csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]);
									unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1;
								}
							}
						}
						else{
							counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] || 0);
								if( !unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]]){
									distinct.push(csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]);
									unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1;
							}
						}
					}
				}
				//console.log(distinct);
				//console.log(counts);
				//console.log(unique);
				var trade_rearr=[]
				var trade_rearr_agg=[]
				for(var dis_i=0; dis_i < distinct.length; dis_i++)
				{		
					if(distinct[dis_i] != undefined)
					{
						for(var csv_val_arr=0; csv_val_arr < csv_val.length; csv_val_arr++)
						{
							old_distinct_val = csv_val[csv_val_arr].split(',').pop();
							if(i == (x.length -1))
							{	
								if(i==0 || old_distinct_val.toString().trim() == distinct[dis_i].split("__")[0].trim())
								{
									trade_val = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct[dis_i].split("__")[1].trim() + "," + counts[distinct[dis_i]];	
								}
							}
							else{	
								if(i==0 || old_distinct_val.toString().trim() == distinct[dis_i].split("__")[0].trim())
								{						
									trade_val = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct[dis_i].split("__")[1].trim();	
								}
							}
							trade_val_arr = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct[dis_i].trim() + "," + counts[distinct[dis_i]];
							trade_rearr.push(trade_val);
						}
						for(var down_csv_val_arr=0; down_csv_val_arr < down_csv_val.length; down_csv_val_arr++)
						{
							trade_val_arr = down_csv_val[down_csv_val_arr] + "," + x.options[i].text + "," + distinct[dis_i] + "," + counts[distinct[dis_i]];
							//console.log(trade_val_arr);
							trade_rearr_agg.push(trade_val_arr);
						}
					}
				}
				trade_rearr = trade_rearr.filter( function( item, index, inputArray ) {
					   return inputArray.indexOf(item) == index;
				});
				csv_val = trade_rearr;
				down_csv_val = trade_rearr_agg;
				console.log(csv_val);
			}
			var csv_val_str = "Category,Level1,Level2,Level3,Level4,";
			var down_csv_val_str = "Category,Family,Group,Typology,Characterictics";
			var level_count_val = 5;
			for(var spl_i=0; spl_i < x.length; spl_i++){
				csv_val_str = csv_val_str + "Level" + (level_count_val) + ","  + "Level" + (level_count_val+1) + ","
				if(spl_i == (x.length-1))
				{
					csv_val_str = csv_val_str + "Failures";
				}
				down_csv_val_str = down_csv_val_str + "," + x.options[spl_i].text + "," +x.options[spl_i].text+" Value"
				level_count_val = level_count_val +2;
			}
			//console.log(csv_val_str);
			//console.log(down_csv_val_str);
			csv_val.splice(0,0,csv_val_str);
			down_csv_val.splice(0,0,down_csv_val_str);
			let csvContent="";
			csv_val.forEach(function(rowArray) {
				csvContent += rowArray.valueOf().replace (/"/g,'') + "\n";
			});
			let down_csvContent="";
			down_csv_val.forEach(function(down_rowArray) {
				down_csvContent += down_rowArray.valueOf().replace (/"/g,'') + "\n";
			});
			//console.log(csvContent.replace (/"/g,''));
			rearrange(csvContent.replace (/"/g,''), down_csvContent.replace (/"/g,''));
		}		
	}
	
	function rearrange(csv_val, download_csv_val)
	{
		var txtFile = new XMLHttpRequest();	
		document.getElementById("Trade_lbl").innerHTML = "Rearrange";		
		var fd = new FormData();
		fd.append("csv_list", csv_val)
		fd.append("down_csv_list", download_csv_val);
		fd.append("user_id",localStorage.getItem("ipm_UserId"));
		fd.append("report_name",localStorage.getItem("reportname"));		
		var today = new Date();
		var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
		var time = today.getHours() + "-" + today.getMinutes() + "-" + today.getSeconds();
		var dateTime = date+''+time;
		var filename="Usage_"+dateTime
		localStorage.setItem("IMP035_filename",filename);
		console.log(filename);
		fd.append("filename", filename)
		txtFile.open("POST", "../cgi-bin/saveCSV.py",true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				allText = this.responseText;	
				var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")	
				//loadData("../html/Reports/"+foldername+"/"+filename+".csv");
				loadData("../html/Reports/"+foldername+"/"+filename+".csv");
			}			
		};
		txtFile.send(fd);
	}
	
	
	function getQueryStrings() {
		var StrVal  = {};
		var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
		var queryString = location.search.substring(1);
		var keyValues = queryString.split('&');

		for(var i in keyValues) {
		var key = keyValues[i].split('=');
		if (key.length > 1) {
		  StrVal[decode(key[0])] = decode(key[1]);
		}
		}
		return StrVal;
	}

	var qs = getQueryStrings();
	var qs_size = Object.keys(qs).length;
	if(qs_size > 1)
	{
		localStorage.setItem("testname",qs["testname"]);
	}

    //Once the document is ready we set javascript and page settings
    var screenWidth;
    var screenHeight;

    $(document).ready(function () {

        var rect;
        if (self==top) {
            rect = document.body.getBoundingClientRect();
        }
        else {
            rect =  parent.document.body.getBoundingClientRect();
        }

        //Set display size based on window size.
        screenWidth = (rect.width < 910) ? Math.round(rect.width*.95) : Math.round((rect.width - 210) *.95);
        screenHeight=700;

        d3.select("#currentDisplay")
                .attr("item_value", (String(screenWidth) + "," + String(screenHeight)))
                .attr("class", "selected")
                .html("<a>" + screenWidth + "px - " + screenHeight + "px</a>");


        $("#cssmenu").menumaker({
            title: "Trade Insertion",
            format: "multitoggle"
			//text-align: "center";
        });

        // Set the size of our container element.
        viz_container = d3.selectAll("#viz_container")
                .style("width", screenWidth + "px")
                .style("height", screenHeight + "px");

		localStorage.setItem("IMP035_filename","IMP035_usage");
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")
        loadData("../html/Reports/"+foldername+"/IMP035_usage.csv");

    });

	function clickDownload(){
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")	
		var filename = "Reports/"+foldername+"/"+localStorage.getItem("IMP035_filename")+".csv";
		window.open(filename, '_blank');
	}
</script>
</body>
</html>
