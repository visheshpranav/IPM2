<html>
<meta http-equiv='cache-control' content='no-cache'>
	<meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
<style>
table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: auto;
	margin-right: 200px;
    margin-top: 50px;
	margin-bottom: 20px;
	height: auto;
	overflow-y: auto;
	overflow-x: auto;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}
th{
align: center;
}

tr:nth-child(even) {
    background-color: #dddddd;
}
</style>
<body onload="getWorkstream();" >
<label id="Heatmap_lbl" style="font-size: 16px; width: 200px; margin-left:200px; margin-top: 10px; float: left; margin-bottom: 0px; display: none;">Click to view <a href="javascript:heatmap();" onclick="heatmap()">Heat</a> map</label>
<label id="ws_lbl" style="font-size: 16px; width: 150px; margin-left:10px; margin-top: 10px; float: left; margin-bottom: 0px; display: none;">Select Workstream: </label>
		
<select id="workstream_drp" onchange="getTcodedetails()" style="width: 200px; float: left; margin-top: 10px; margin-bottom: 0px;  display: none;"></select> 				
 
<a href="javascript:clickDownload();" id ="Download_Usageanalysis" ><img src="../images/Download.png"  style="color:black; width: 48px; height: 30px; margin-top: 20px; margin-right: 30px; float: right;" ></a>
<br/><br/>
<label id="ws_item_lbl" style="font-size: 24px; font-weight: bold; width: 350px; margin-left:10px; margin-top: 30px; margin-bottom: 20px; text-decoration: underline; display: none;"></label><br/><br/><br/>
<svg width="550" height="450" font-family="sans-serif" font-size="12" style="float: left; margin-top: 0px;" text-anchor="middle"></svg>
<label id="legend1" style="float: left;margin-left:-500px; margin-top:550px; display:none;"><label>Size of bubble in the chart represents the number of times the workstream called</label></br></label>
<label id="legend2" style="float: left;margin-left:-500px; margin-top:550px; display:none;"><label>Size of bubble in the chart represents the number of times the TCODES called</label></br></label>
<h1 id="hdr_report" style="font-size: 18px; width: 400px; margin-top: -20px; text-decoration: underline; display:none; float:left; "></h1><br/>
<table id="bubble_tbl" style="width: 400px;">
</table>

<script src="../JScript/d3.v4.min.js"></script>
<script src="../JScript/Lapam.js"></script>
<script>


//var log_folder = localStorage.getItem("UserId") +"_"+localStorage.getItem("PrjId")+"_"+localStorage.getItem("testname").toLowerCase()
//alert(localStorage.getItem("UserId"))
// function to get query string value
function getQueryStrings() { 
  var StrVal  = {};
  var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
  var queryString = location.search.substring(1); 
  var keyValues = queryString.split('&'); 

  for(var i in keyValues) { 
    var key = keyValues[i].split('=');
    if (key.length > 1) {
      StrVal[decode(key[0])] = decode(key[1]);
    }
  } 
  return StrVal; 
} 
var qs = getQueryStrings();
var qs_size = Object.keys(qs).length;
if(qs_size > 1)
{
	localStorage.setItem("log_type",qs["log_type"]);
}
if(qs_size > 1)
{
	localStorage.setItem("testname",qs["testname"]);
}	
document.getElementById("Heatmap_lbl").style.display = "none";
document.getElementById("ws_lbl").style.display = "block";
document.getElementById("ws_item_lbl").style.display = "block";
document.getElementById("workstream_drp").style.display = "block";
document.getElementById("hdr_report").style.display = "block";
document.getElementById("bubble_tbl").style.display = "block";
document.getElementById("legend1").style.display = "none";
document.getElementById("legend2").style.display = "none";

     
function clickDownload(){
	window.open(filename, '_blank');
}

function getWorkstream()
{

	document.getElementById("legend1").style.display = "none";
	document.getElementById("legend2").style.display = "none";
	var ws_drp = document.getElementById("workstream_drp");	
	var ws_length = ws_drp.options.length;
	for (j = 0; j < ws_length; j++) {
	  ws_drp.options[0] = null;
	}
	
	var xhttp = new XMLHttpRequest();
	var fd = new FormData();
	
	fd.append("user_id",localStorage.getItem("ipm_UserId"));
	fd.append("rep_id",localStorage.getItem("rep_id"));
	fd.append("report_name",localStorage.getItem("reportname"));
	fd.append("function_name","SAPUsageAnalysis");
	fd.append("app_name","empty");
	fd.append("uploaded_filename","empty");
	fd.append("mode","OFL");
	fd.append("Imp_id","empty");
	fd.append("observation","empty");
	fd.append("imp_name","empty");
	fd.append("start_date","empty");
	fd.append("end_date","empty");
	fd.append("search_key","empty");
	
    /*fd.append("userid", localStorage.getItem("ipm_UserId"));
    fd.append("prjid", );
    fd.append("Txt_testname", localStorage.getItem("reportname") );*/
	/*if(localStorage.getItem("WorkstreamName") == "" && localStorage.getItem("WorkstreamName") == null)
	{
		var option = document.createElement("option");
		option.text = "All Workstreams";
		ws_drp.add(option, ws_drp[0]);
	}*/

	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var test_length = ws_drp.options.length;
			for (i = 1; i < test_length; i++) {
			  ws_drp.options[0] = null;
			}
			var ws_name_arr = this.responseText.split("\n");
			var option = document.createElement("option");
			option.text = "All Workstreams";
			ws_drp.add(option, ws_drp[0]);
			for (var ws_i=0; ws_i<ws_name_arr.length -1; ws_i=ws_i+1) {					
				var option = document.createElement("option");
				option.text = ws_name_arr[ws_i];
				ws_drp.add(option, ws_drp[ws_i+1]);
			} 
			if(localStorage.getItem("WorkstreamName") != "" && localStorage.getItem("WorkstreamName") != null)
		{
		setSelectedValue(workstream_drp, localStorage.getItem("WorkstreamName"));
		document.getElementById('ws_item_lbl').innerHTML = localStorage.getItem("WorkstreamName");
		if(localStorage.getItem("WorkstreamName") == "All Workstreams")
		{
		document.getElementById("legend1").style.display = "block";
		document.getElementById("legend2").style.display = "none";
		}
		else{
		document.getElementById("legend1").style.display = "none";
		document.getElementById("legend2").style.display = "block";
		}
		ws_drp.options[ws_drp.selectedIndex].text = localStorage.getItem("WorkstreamName");
	}
	else
	{
		setSelectedValue(workstream_drp, "All Workstreams");
		document.getElementById('ws_item_lbl').innerHTML = "All Workstreams";
		localStorage.setItem("WorkstreamName","All Workstreams");
		document.getElementById("legend1").style.display = "block";
		document.getElementById("legend2").style.display = "none";
		
	}
         }
     };
     xhttp.open("POST", "../cgi-bin/Decrypt_PyFile.py",true);
     xhttp.send(fd);
	 
	/*var option = document.createElement("option");
	option.text = "All Workstreams";
	ws_drp.add(option, ws_drp[0]);
	var option1 = document.createElement("option");
	option1.text = "Sales and Distribution";
	ws_drp.add(option1, ws_drp[1]);
	var option2 = document.createElement("option");
	option2.text = "Supply Chain";
	ws_drp.add(option2, ws_drp[2]);
	var option3 = document.createElement("option");
	option3.text = "Production Orders";
	ws_drp.add(option3, ws_drp[3]);
	var option4 = document.createElement("option");
	option4.text = "Quality Management";
	ws_drp.add(option4, ws_drp[4]);
	var option5 = document.createElement("option");
	option5.text = "CustomerRelationshipManagement";
	ws_drp.add(option5, ws_drp[5]);
	var option6 = document.createElement("option");
	option6.text = "Manufacturing";
	ws_drp.add(option6, ws_drp[6]);
	var option7 = document.createElement("option");
	option7.text = "Materials Management";
	ws_drp.add(option7, ws_drp[7]);
	var option8 = document.createElement("option");
	option8.text = "Warehouse Management";
	ws_drp.add(option8, ws_drp[8]);
	var option9 = document.createElement("option");
	option9.text = "Logistics";
	ws_drp.add(option9, ws_drp[9]);
	var option10 = document.createElement("option");
	option10.text = "Customer Service";
	ws_drp.add(option10, ws_drp[10]);*/
	
}

	getObservation();

function getTcodedetails(){
	//parent.document.getElementById('top').style.display = 'block';
	var workstream_drp = document.getElementById('workstream_drp');
	var ws_name = workstream_drp.options[workstream_drp.selectedIndex].text;	
	//alert(ws_name)
	localStorage.setItem("WorkstreamName",ws_name);	
	//parent.document.getElementById('top').style.display = 'none';
	localStorage.setItem("wsArr",this.responseText);
	//parent.ifm_content.src = "templates/UA_SAP.html";
	window.location.href = "IMP015.html"
	//alert(ws_name)
	setSelectedValue(workstream_drp, ws_name);
}

// function to set Selected workstream
function setSelectedValue(selectObj, valueToSet) {
    for (var i = 0; i < selectObj.options.length; i++) {
        if (selectObj.options[i].text== valueToSet) {
            selectObj.options[i].selected = true;
            return;
        }
    }
}

//check CSV file exist
function fileExists(url) {
    if(url){
        var req = new XMLHttpRequest();
        req.open('GET', url, false);
        req.send();
        return req.status==200;
    } else {
        return false;
    }
}

var table = document.getElementById("bubble_tbl");
var row_count = 1;
var rowCount = table.rows.length;
console.log (localStorage.getItem("WorkstreamName"));
if (localStorage.getItem("WorkstreamName") == "All Workstreams"){
	document.getElementById('hdr_report').innerHTML = "Top 10 Workstreams";
	var header = table.createTHead();
	var row = header.insertRow(0); 
	var cell = row.insertCell(0);
	cell.innerHTML = "<b>WorkStream</b>";
	var cell1 = row.insertCell(1);
	cell1.innerHTML = "<b>Unique Tcode Count</b>";
	document.getElementById("legend1").style.display = "block";
	document.getElementById("legend2").style.display = "none";
}
else{
	document.getElementById('hdr_report').innerHTML = "";
	var header = table.createTHead();
	var row = header.insertRow(0); 
	var cell = row.insertCell(0);
	cell.innerHTML = "<b>Tcode</b>";
	var cell1 = row.insertCell(1);
	cell1.innerHTML = "<b>Transaction Count</b>";
	document.getElementById("legend1").style.display = "none";
	document.getElementById("legend2").style.display = "block";
}

//alert(table.rows.length);
if(table.rows.length != 0)
{
	for (var x=1; x < rowCount; x++) 
	{		
		if(table.rows.length > 2)
		{
			table.deleteRow(1);
		}              
	} 
}
		
var log_folder = localStorage.getItem("ipm_UserId") +"_"+localStorage.getItem("rep_id")+"_"+localStorage.getItem("reportname").toLowerCase();
var filename = ""
/*if(localStorage.getItem("WorkstreamName") == "Basis/ABAP")
{
filename = "..\\Reports\\BasisABAP.csv";
}
else if(localStorage.getItem("WorkstreamName") == "FI - Financial Accounting")
{
filename = "..\\Reports\\FI - Financial Accounting.csv";
}
else if(localStorage.getItem("WorkstreamName") == "Basis - Session Manager")
{
filename = "..\\Reports\\Sessionmgr.csv";
}
else if(localStorage.getItem("WorkstreamName") == "Material Management - IM")
{
filename = "..\\Reports\\Material.csv";
}
else if(localStorage.getItem("WorkstreamName") == "Basic Components")
{
filename = "..\\Reports\\BasicComponents.csv";
}
else
{
filename = "..\\Reports\\allworkstream.csv";
}*/
filename = "Reports\\"+log_folder+"\\"+localStorage.getItem("WorkstreamName").replace("/","_")+".csv";
console.log(filename)
var svg = d3.select("svg"),
    width = +svg.attr("width"),
	fontsize = +svg.attr("font-size"),
    height = +svg.attr("height");

var format = d3.format(",d");

var fontsize1 = [];
var j = -1;
var color = d3.scaleOrdinal(d3.schemeCategory20c);

var pack = d3.pack()
    .size([width, height])
    .padding(1.5);
// insert into bubble table
//if(fileExists(filename))
//{
d3.csv(filename, function(d) {
  d.value = +d.value;
	var row = table.insertRow(row_count);
	var cell1 = row.insertCell(0);
	var cell2 = row.insertCell(1);
	//alert(d.id.toString());
	//alert(d.value.toString());
	cell1.innerHTML = d.id.toString();
	cell2.innerHTML = d.value.toString();
	row_count++;
  
  if (d.value) return d;
}, function(error, classes) {
  if (error) throw error;

  var root = d3.hierarchy({children: classes})
      .sum(function(d) { return d.value; })
      .each(function(d) {
        if (id = d.data.id) {
          var id, i = id.lastIndexOf("/");
          d.id = id;
          d.package = id.slice(0, i);
          d.class = id.slice(i + 1);
        }
      });

  var node = svg.selectAll(".node")
    .data(pack(root).leaves())
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("circle")
      .attr("id", function(d) { return d.id; })
      .attr("r", function(d) { return d.r; })
      .style("fill", function(d) { return color(d.package); });

  node.append("clipPath")
      .attr("id", function(d) { return "clip-" + d.id; })
    .append("use")
      .attr("xlink:href", function(d) { return "#" + d.id; });
	  

  node.append("text")
      .attr("clip-path", function(d) { return "url(#clip-" + d.id + ")"; })
	  .selectAll("tspan")
    .data(function(d) { fontsize1.push(d.r/3);
	var d_name = d.id;
	console.log(d_name+"|"+d_name.length);
	if (d_name.length < 6)
	{
	return d.id.substring(d.id.lastIndexOf("/") + 1).split(/-/g);
	}
	else
	{
	return d.id.substring(d.id.lastIndexOf("/") + 1).split(/(?=[A-Z][^A-Z])/g); }})
    .enter().append("tspan")
      .attr("x", 0)
      .attr("y", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; })
	  .attr("font-size", "10px")
	  .attr("font-weight", "bold")
      .text(function(d) { 
	  return d; })
	  
       <!-- .text(function(d) { return d.class }) -->
	  <!-- .each(wrap,function(d, i, nodes) {  -->
				<!-- return 13 + (i - nodes.length / 2 - 0.5) * 10; }); -->

  node.append("title")
      .text(function(d) { return d.id + "\n" + format(d.value); });
});
/*}
else{
alert("Kindly process the log in Qualify page to view the analysis");
document.getElementById("ifm_content").src = "ViewQualifier.html";
}*/

function wrap(d,x_val) {
//console.log(d);
	w = d.r / 3;
	d_name = d.class;
	<!-- if (w < d_name.length) -->
	<!-- { -->
    var text = d3.select(this),
      width = d.r / 3,
      x = x_val-10,
	  //fontsize = d.r/3,
	  fontsize = 12,
      y = -20,
      words = text.text().split(/_/).reverse(),
      word,
      line = [],
      lineNumber = 0,
      lineHeight = 1.1,
      tspan = text.text(null).append("tspan").attr("x", x).attr("y", y);
	  //console.log(words+"|"+d.r);
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" ")).attr("font-size", fontsize).attr("font-weight", "bold");
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
		//console.log(line);
        tspan.text(line.join(" "));
        line = [word];
		if (fontsize > width)
		{
		fontsize = width;
		}
		console.log(word.length+"|"+fontsize+"|"+word+"|"+width);
		
        tspan = text.append("tspan").attr("x", x-4).attr("y", y+7).attr("font-size", fontsize).attr("font-weight", "bold").attr("dy", ++lineNumber * lineHeight + "em").text(word);
      
	  }
	  
    }
	<!-- } -->
	<!-- else -->
	<!-- { -->
	 <!-- tspan = text.append("tspan").attr("x", 0).attr("y", x_val).attr("font-size", 14).attr("font-weight", "bold").text(word); -->
	<!-- } -->
}

</script>
</body>
</html>
