<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<link rel="stylesheet" href="../styles/font-awesome/css/font-awesome.min.css">
    <!-- We use google fonts for many of the examples, but they are not necessary -->
    <link href='../styles/googleapis_Roboto.css' rel='stylesheet' type='text/css'>
	
    <!-- Test container style sheets -->
    <link rel="stylesheet" href="../styles/examples.css">

    <!-- Vizuly specific style sheets -->
    <link rel="stylesheet" href="../styles/vizuly.css">
    <link rel="stylesheet" href="../styles/vizuly_weightedtree.css">

    <!-- Supporting test container files:  Vizuly does NOT rely on these -->
    <link href="../styles/googleapis_materialicon.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/cssmenu.css">
    <script type="text/javascript" src="../JScript/jquery-2.1.1.min.js"></script>
    <script src="../JScript/cssmenu.js"></script>

    <!-- D3.js ... of course! -->
    <script src="../JScript/d3.min.js"></script>

    <!-- debug source scripts: end -->


	<title>Deliverable MXML</title>
    <script src="../JScript/vizuly_core.min.js"></script>
	<script src="../JScript/vizuly_weightedtree.min.js"></script>
    <script src="../JScript/RCA_del.js"></script>
	<style>
	
	@font-face {
	font-family: 'AccentureRotis';
	src: url('../styles/rotsan.woff') format('woff'); /* Modern Browsers */
	}

	body {
    font-family: AccentureRotis,Arial,sans-serif;
	}
	#header_div
	{
	float: left;
	margin-top: 30px;
	}
	#lstBox1, #lstBox2 {
		width: 235px;
		height: 100px;
		padding: 0;
		margin-top: 2px;
		font-size:12px;
		font-family: AccentureRotis,Arial,sans-serif;
	}
	#lstBox2{
		margin-left: 44px;
		float: left;
	}
	#btnAllRight {
	width: 30px;
	height: 30px;
    margin-left: 50px;
	margin-top: 5px;
	transform: rotate(90deg);
	font-weight: bold;
	border-radius: 5px;
	outline: none;
	}
	#btnRight,#btnLeft,#btnAllLeft {
		width: 30px;
		height: 30px;
		margin-left: 5px;
		margin-top: 5px;
		transform: rotate(90deg);
		font-weight: bold;
		border-radius: 5px;
		outline: none;
	}
	#CompareTest_lbl1,#CompareTest_lbl{
		width: 150px;
		height: 150px;
		padding: 0;
		font-weight: bold;
	}
	#CompareTest_lbl1{
		margin-left: 44px;
	}

	.btn { 
		background: DodgerBlue;
		border: 2px solid DodgerBlue;
		border-radius: 2px;
		color: white;
		cursor: pointer;
		width: 130px;
		height: 25px;	
		line-height: 10px;
		font-family: AccentureRotis,Arial,sans-serif;
	}

	.btn_compare {
		background-color: DodgerBlue;
		color:#ffffff;
		font-family:Arial;
		font-size:14px;
		margin-left:16%;
		margin-top: 2%;
		padding: 6px 12px;
		border: none;
		cursor: pointer;
		border-radius: 15px;
		outline: none;
		font-family: AccentureRotis,Arial,sans-serif;
	}
	.btnn {
		background-color: DodgerBlue;
		border: none;
		color: white;
		padding: 6px 12px;
		cursor: pointer;
		font-size: 14px;
		border-radius: 15px;
		outline: none;
		font-family: AccentureRotis,Arial,sans-serif;
	}

.list-heading {
      font-size: 14px;
      margin: 0;
      padding: 5px !important;
	  border-bottom: solid 2px rgba(223, 223, 223, 0.5);
      color: #FFF;
      background-color: #333;
      padding-right: 118.1px !important;
	  
    }
.list-heading1 {
      font-size: 14px;
      margin: 0;
      padding: 5px !important;
      color: #FFF;
      background-color: #333;
      padding-right: 85.5px !important;
    }
   
	</style>
</head>
<body onload="getTradeValue()">

	<div id='cssmenu'>
		<ul class="main-menu">
			<li class='active'>
				<a><span>Display</span><br><span class="setting"></span></a>
				<li id="currentDisplay"></li>               
			</li>
		</ul>
	</div>
	
	
	<label style="float: right; font-size: 14px; font-weight:bold; text-decoration: underline; margin-left: 30%; margin-top: 15px; width: 50%; position: absolute;" id="Trade_lbl"></label>
	<!--<button class="btnn" id="expand_button" onclick="expandall()" style="float:right; margin-left: 20px; margin-top: 12px;  position: absolute;font-family: Helvetica Neue,Helvetica,Arial,sans-serif"><i class="fa fa-expand"></i> Expand</button>-->
    <button class="btnn" id="collapse_button" onclick="collapseall()" style="float:right; margin-left: 20px; margin-top: 12px; position: absolute;"><i class="fa fa-compress"></i>  Collapse</button>
    <div id="viz_container" style="float: left; width: 76%;height: 650px; border: solid; margin: 5px; overflow:scroll;">
  
	</div>
	<div id="filter_div" style="float: left; width: 20%;height: 590px;border: solid; margin: 5px; border-radius: 6px; position:sticky;">
	
		<button class="btnn" id="rearr" onclick="javascript:void(0);" style="float:left; margin:5px;  background-color: grey; margin-left: 4%"><i class="fa fa-download" style="padding-right:5px"></i>  Filter data</button>
	   	<button class="btnn" id="dfault" onclick="javascript:clickDownload2();" style="float:left; margin:5px"><i class="fa fa-download" style="padding-right:5px"></i>  Master data</button>
 <br/>
 
	<!--<label id="filter_lbl" style="margin-left: 2%; margin-top: 50px;">Filtered Data: </label>
	<select id="slt_filter_trade" onchange="bindFilterdata()" style="border-radius: 10px;width: 120px;border: solid; border-width: thin; padding-left: 5px;">
		</select><br/><br/>-->
	   <label id="trade_lbl" style="margin-left: 4%; margin-top: 15px; float: left; font-size:14px; margin-right: 5px">Trade Filter: </label>
	   <select id="slt_trade" onchange="bindlist1details()" style="border-radius: 5px;width: 150px;border: solid; border-width: thin; padding-left: 5px;margin-top: 15px; margin-left: 12px; float: left;">
		</select><br/>
		
	
  
	<div id="header_div" style="margin-left: 4%;margin-top: 15px; float: left;">
		<label class="list-heading" id="CompareTest_lbl" >Trade characteristics </label></br>
		<select multiple="multiple" id='lstBox1' ></select>
	</div>
	<div id="header_div" style="margin-top: 10px;"><!--class="subject-info-arrows text-center"-->
	<input type='button' id='btnAllRight' data-toggle="tooltip" data-placement=">>" title="Click to move all items to down" value='>>' class="btn btn-default" />
	<input type='button' id='btnRight' data-toggle="tooltip" data-placement=">" title="Click to move selected items to down" value='>' class="btn btn-default" />
	<input type='button' id='btnLeft' data-toggle="tooltip" data-placement="<" title="Click to move selected items to top" value='<' class="btn btn-default" />
	<input type='button' id='btnAllLeft' data-toggle="tooltip" data-placement="<<" title="Click to move all items to top" value='<<' class="btn btn-default" />
	</div>
	<div id="header_div" style="margin-left: -13%;margin-top: 20px;">
	  <label class="list-heading1" id="CompareTest_lbl1">Trade characteristics order </label></br>
	  <select multiple="multiple" id='lstBox2' ></select></br>
	  <!-- <label style="float: left; font-size: 12px; margin-left: 40px; margin-top: 5px; width: 250px;">The above characteristics order will position the top node as parent for the immediate next node</label></br>
	 --></div>
	<div style="width:100%; float: left; margin-top: 10px; text-align: center;">
	<!--<input type="button" value="View Master data" id ="master_bf" class="btn_compare" onclick="masterCsv();">-->
	<input type="button" value="Apply filter" id ="save_bf" class="btn_compare" style="margin-left: 2%" onclick="readMasterCSV();">
	</div>
	</br>
</div>
	<!-- <div class="sticky"></div> -->

<script>
    var screenWidth;
    var screenHeight;
	var filename = "../html/Reports/DeliverableWF_Data.csv";
	var filename1 = "../html/Reports/DeliverableWF_Data.csv";
	
	var qs = getQueryStrings();
	var qs_size = Object.keys(qs).length;
	sessionStorage.setItem("isRearrange","false");
	if(qs_size > 1)
	{
		localStorage.setItem("testname",qs["testname"]);
	}

  	function getQueryStrings() {
	  var StrVal  = {};
	  var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
	  var queryString = location.search.substring(1);
	  var keyValues = queryString.split('&');

	  for(var i in keyValues) {
		var key = keyValues[i].split('=');
		if (key.length > 1) {
		  StrVal[decode(key[0])] = decode(key[1]);
		}
	  }
	  return StrVal;
	}
	
	var CSVToArray = function CSVToArray(data) {
		var delimiter =
			arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ",";
		var omitFirstRow =
			arguments.length > 2 && arguments[2] !== undefined
				? arguments[2]
				: false;
	 
		return data
			.slice(omitFirstRow ? data.indexOf("\n") + 1 : 0)
			.split("\n")
			.map(function(v) {
				return v.split(delimiter);
			});
	};
	
	var csvArray = []
	var response_val = "";
	//function to read master csv file and bind into dropdown value
	function getTradeValue()
	{
		var txtFile = new XMLHttpRequest();
		var allTextLines = ""
		var i=0;
		var header_val = []
		var tradeval_arr = []
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");	
		//var foldername="44_Murex_test"
		txtFile.open("GET", "../html/Reports/"+foldername+"/IMP036_Delivery.csv", true);
		//txtFile.open("GET", "../html/Reports/murexold.csv", true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				allText = this.responseText;
				response_val = allText;				
				document.getElementById("Trade_lbl").innerHTML = "Master data";
				/*if(i == 0)
				{
					header_val = (allText.split('\n'))[0].split(',');
					for(var j=5; j < header_val.length; j++)
					{
						var opt = document.createElement("option");
						opt.text = header_val[j];
						document.getElementById("lstBox1").options.add(opt);
					}
					i = i+1;*/
					res_txt = allText.split('\n');
					for(var res_i=1; res_i < res_txt.length; res_i++)
					{
						val_arr = res_txt[res_i].split(',');
						tradeval_arr.push(val_arr[1]);
					}					
				//}
				//console.log(tradevalue);
				const uniqueTradeValue = Array.from(new Set(tradeval_arr));
				for (var uni_i = 0; uni_i < uniqueTradeValue.length; uni_i++) {
					if(uniqueTradeValue[uni_i] != undefined && uniqueTradeValue[uni_i] != "")
					{
					var opt = document.createElement("option");
					opt.text = uniqueTradeValue[uni_i];
					document.getElementById("slt_trade").options.add(opt);
					}
				}
				$('#slt_trade').append('<option value="All">All</option>');
				csvArray = CSVToArray(allText);
				$('#slt_trade').val('All');
				bindlist1details();
			}
			
		};
		txtFile.send();
	}
	
	function bindlist1details()
	{ 
		if($("#slt_trade option:selected").text() == "All")
		{
			sessionStorage.setItem("isRearrange","false");
			masterCsv();		
		}
		var list_val = document.getElementById("lstBox1")
		var length = list_val.options.length;
		for (i = length-1; i >= 0; i--) {
		  list_val.options[i] = null;
		}
		var list2_val = document.getElementById("lstBox2")
		var length2 = list2_val.options.length;
		for (j = length2-1; j >= 0; j--) {
		  list2_val.options[j] = null;
		}
		res_txt = response_val.split('\n');
		var sel_box1 = []
		var sel_val = document.createElement("slt_trade")
		for(var res_i=1; res_i < res_txt.length; res_i++)
		{
			val_arr = res_txt[res_i].split(',');
			if(val_arr[1] == $("#slt_trade option:selected").text())
			{
				tradeconst = val_arr[1];
				sel_box1.push(val_arr[2]);
			}
		}	
		var unique = sel_box1.filter((v, i, a) => a.indexOf(v) === i);
		for(var j=0; j < unique.length; j++)
		{
			var opt = document.createElement("option");
			opt.text = capitalizeFirstLetter(unique[j]);
			document.getElementById("lstBox1").options.add(opt);
		}
		console.log(unique);
	}
	
	getUniqueTradeCount();
	var master_unique = [];
	var master_counts = {};
	function getUniqueTradeCount()
	{
		var txtFile = new XMLHttpRequest();
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");
		txtFile.open("GET", "../html/Reports/"+foldername+"/Del_master.csv", true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				mastercsvArray = CSVToArray(this.responseText);
				//unique[mastercsvArray[5]] = 1;
				var master_trdhdr_value = "";
				var master_typhdr_value = "";
				for( let hdr_i = 0; hdr_i < mastercsvArray[0].length; hdr_i++ ){
					if(mastercsvArray[0][hdr_i].trim() === "Contract ID"){
						master_trdhdr_value = hdr_i;	
					}
					else if(mastercsvArray[0][hdr_i].trim() === "Trade Typology"){
						master_typhdr_value = hdr_i;	
					}
				}
				for( let csv_i = 1; csv_i < mastercsvArray.length; csv_i++ ){
					if(mastercsvArray[csv_i][master_typhdr_value] != "")
					{
						master_counts[mastercsvArray[csv_i][master_typhdr_value] +"__"+mastercsvArray[csv_i][master_trdhdr_value]] = 1 + (master_counts[mastercsvArray[csv_i][master_typhdr_value] +"__"+mastercsvArray[csv_i][master_trdhdr_value]] || 0);
						
					}
				}
				for (var key in master_counts){
				  master_unique[key.split("__")[0]] = 1 + (master_unique[key.split("__")[0]] || 0)
				} 
				console.log(master_counts)
				console.log(master_unique)
			}
			
		};
		txtFile.send();
	}
	
	function readMasterCSV()
	{
		var txtFile = new XMLHttpRequest();
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname");
		txtFile.open("GET", "../html/Reports/"+foldername+"/Del_master.csv", true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				csvArray = CSVToArray(this.responseText);
				createCsv();
			}
			
		};
		txtFile.send();
	}
	
	function createCsv()
	{
		var x = document.getElementById("lstBox2");
		var csv_val = [];
		var down_csv_val = [];
		var hdr_value = "";
		var root_hdr_val = "";
		var old_distinct_val = "";
		var old_distinct_val_arr = []
		var hdr_val_arr = []
		if(x.length > 0)
		{		
			csv_val.push(tradeconst)
			down_csv_val.push(tradeconst)
			
			for (i = 0; i < x.length; i++) { 
				for( let hdr_i = 0; hdr_i < csvArray[0].length; hdr_i++ ){
					if( x.options[i].text.trim().toLowerCase() === csvArray[0][hdr_i].trim().toLowerCase()){
						hdr_value = hdr_i;
					}
					if(i>=1)
					{
						if( x.options[i-1].text.trim().toLowerCase() === csvArray[0][hdr_i].trim().toLowerCase()){
							root_hdr_val = hdr_i;
							hdr_val_arr.push(root_hdr_val);
						}
					}
				}
				//var unique = [];
				var unique_new = [];
				//var counts = {};
				var counts_new = {};
				//var distinct = [];
				var distinct_new = [];
				//unique[csvArray[5]] = 1;
				for( let csv_i = 0; csv_i < csvArray.length; csv_i++ ){
					if(csvArray[csv_i][hdr_value] != "" && csvArray[csv_i][2] === $("#slt_trade option:selected").text())
					{
						if(i >= 1){
							if(csvArray[csv_i][root_hdr_val] != "")
							{
								/*counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] || 0);
								if( !unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]]){
									distinct.push(csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]);
									unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1;
								}*/
								for(let old_dis = 0; old_dis < old_distinct_val_arr.length; old_dis++)
								{
									var old_val = "";
									for(var old_hdr_i=0; old_hdr_i < hdr_val_arr.length; old_hdr_i++)
									{
										if(old_val != "")
										{
											old_val = old_val + "__" + csvArray[csv_i][hdr_val_arr[old_hdr_i]];
										}
										else{
											old_val = csvArray[csv_i][hdr_val_arr[old_hdr_i]];
										}
									}
									if(old_val == old_distinct_val_arr[old_dis])
									{
										counts_new[old_distinct_val_arr[old_dis] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts_new[old_distinct_val_arr[old_dis] +"__"+csvArray[csv_i][hdr_value]] || 0);
										if( !unique_new[old_distinct_val_arr[old_dis] +"__"+csvArray[csv_i][hdr_value]]){
											distinct_new.push(old_distinct_val_arr[old_dis] +"__"+csvArray[csv_i][hdr_value]);
											unique_new[old_distinct_val_arr[old_dis] +"__"+csvArray[csv_i][hdr_value]] = 1;
										}
									}
								}
							}
						}
						else{
							//counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] || 0);
							counts_new[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1 + (counts_new[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] || 0);
								if( !unique_new[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]]){
									//distinct.push(csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]);
									distinct_new.push(csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]);
									//unique[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1;
									unique_new[csvArray[csv_i][root_hdr_val] +"__"+csvArray[csv_i][hdr_value]] = 1;
							}
						}
					}
				}
				var trade_rearr=[]
				var trade_rearr_agg=[]
				for(var new_dis_i=0; new_dis_i < distinct_new.length; new_dis_i++)
				{		
					if(distinct_new[new_dis_i] != undefined)
					{
						for(var csv_val_arr=0; csv_val_arr < csv_val.length; csv_val_arr++)
						{							
							old_distinct_val = csv_val[csv_val_arr].split(',').pop();							
							new_distinct_val_arr = csv_val[csv_val_arr].split(',');//.slice(6, csv_val[csv_val_arr].length);
							new_distinct_val = "";
							for (var new_i=2;new_i<new_distinct_val_arr.length;new_i=new_i +2){
								if(new_distinct_val != "")
								{
									new_distinct_val = new_distinct_val + "__" + new_distinct_val_arr[new_i];
								}
								else
								{
									new_distinct_val = new_distinct_val_arr[new_i];
								}
							}
							distinct_new_val = distinct_new[new_dis_i].split("__").slice(0, -1).join('__');
							if(i == (x.length -1))
							{	
								if(new_distinct_val.toString().trim() == distinct_new_val.trim())
								{
									new_trade_val = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct_new[new_dis_i].split("__").pop().trim() + "," + counts_new[distinct_new[new_dis_i]];	
								}
								else if(i==0 || distinct_new_val.trim() == "undefined")
								{
									new_trade_val = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct_new[new_dis_i].split("__").pop().trim() + "," + counts_new[distinct_new[new_dis_i]];	
								}
							}
							else{	
								if(i==0 || new_distinct_val.toString().trim() == distinct_new_val.trim())
								{						
									new_trade_val = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct_new[new_dis_i].split("__").pop().trim();	
								}
							}
							//trade_val_arr = csv_val[csv_val_arr] + "," + x.options[i].text.trim() + "," + distinct_new[new_dis_i].trim() + "," + counts[distinct_new[new_dis_i]];
							trade_rearr.push(new_trade_val);
							trade_rearr_agg.push(new_trade_val);
						}
					}					
					if(distinct_new[new_dis_i].split('__')[0] == "undefined")
					{
						distinct_new[new_dis_i] = distinct_new[new_dis_i].split('__')[1];
					}
				}
				trade_rearr = trade_rearr.filter( function( item, index, inputArray ) {
					   return inputArray.indexOf(item) == index;
				});
				trade_rearr_agg = trade_rearr_agg.filter( function( item, index, inputArray ) {
					   return inputArray.indexOf(item) == index;
				});
				csv_val = trade_rearr;
				down_csv_val = trade_rearr_agg;
				console.log(csv_val);
				old_distinct_val_arr = distinct_new;
			}
			var csv_val_str = "Category";
			var down_csv_val_str = "Category,Typology";
			
			for(var spl_i=0; spl_i < x.length; spl_i++){
				csv_val_str = csv_val_str + "," + x.options[spl_i].text.trim() + "," +x.options[spl_i].text+" Value"
				if(spl_i == (x.length-1))
				{
					csv_val_str = csv_val_str + ",Count";
				}
			}
			csv_val.splice(0,0,csv_val_str);
			down_csv_val.splice(0,0,down_csv_val_str);
			let csvContent="";
			csv_val.forEach(function(rowArray) {
				csvContent += rowArray.valueOf().replace (/"/g,'') + "\n";
			});
			let down_csvContent="";
			down_csv_val.forEach(function(down_rowArray) {
				down_csvContent = "";
			});
			
			rearrange(csvContent.replace (/"/g,''), down_csvContent.replace (/"/g,''));
			//loadData("../html/Reports/murexold_281020200700.csv");
		}
		
	}
	var filter_num = 1;	
	var filter_arr = [];
	if(sessionStorage.getItem("filter_array") != "")
	{
		filter_arr.push(sessionStorage.getItem("filter_array"));
	}
	
	function rearrange(csv_val, download_csv_val)
	{
		
		sessionStorage.setItem("isRearrange","true");
		$("#rearr").attr("onclick", "javascript:clickRearrangeDownload();");
		document.getElementById("rearr").style.backgroundColor = "DodgerBlue";
		/*$('#slt_filter_trade').empty();
		var opt = document.createElement("option");
		opt.text = "-- Select --";
		opt.value = "1";
		document.getElementById("slt_filter_trade").options.add(opt);*/
		var txtFile = new XMLHttpRequest();		
		document.getElementById("Trade_lbl").innerHTML = "Filter Data";
		var fd = new FormData();
		fd.append("csv_list", csv_val);
		console.log(csv_val);
		fd.append("down_csv_list", download_csv_val);
		console.log(download_csv_val);
		fd.append("user_id",localStorage.getItem("ipm_UserId"));
		fd.append("report_name",localStorage.getItem("reportname"));		
		var today = new Date();
		var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
		var time = today.getHours() + "-" + today.getMinutes() + "-" + today.getSeconds();
		var dateTime = date+''+time;
		var filter_arr_name = "Filterdata_"+ (filter_arr.length + 1) + "_"+dateTime;
		filter_arr.push(filter_arr_name);
		sessionStorage.setItem("filter_array",filter_arr);
		var filename="Delvy_Rearrange"+dateTime
		localStorage.setItem("dat",dateTime);
		localStorage.setItem("IMP036_filename",filename);
		console.log(filename);
		if(filter_arr.length > 1)
		{
			/*$("#slt_filter_trade").show();
			for (var fil_i = 0; fil_i < filter_arr.length; fil_i++) {
				if(filter_arr[fil_i] != undefined && filter_arr[fil_i] != "")
				{
					var opt = document.createElement("option");
					opt.text = (filter_arr[fil_i].split("_")).slice(0, 2).join("_");
					opt.value = filter_arr[fil_i];
					document.getElementById("slt_filter_trade").options.add(opt);				
				}
			}*/
		}
		filter_num = filter_num+1;
		fd.append("filename", filename)
		fd.append("dateTime",dateTime) 
		tradename = $("#slt_trade option:selected").text()
		fd.append("tradename",tradename);
		txtFile.open("POST", "../cgi-bin/saveCSV.py",true);
		txtFile.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200)
			{
				allText = this.responseText;	
				var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")+"/"+tradename+"_"+dateTime;
				loadData("../html/Reports/"+foldername+"/"+filename+".csv");
			}			
		};
		txtFile.send(fd);
	}
	
	function capitalizeFirstLetter(string) {
	  return string.charAt(0).toUpperCase() + string.slice(1);
	}

	
	function bindFilterdata()
	{
		if($("#slt_filter_trade option:selected").val() != "1")
		{
			var filter_filename = "Delvy_Rearrange" + ($("#slt_filter_trade option:selected").val()).split('_').pop();
			var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")
			loadData("../html/Reports/"+foldername+"/"+filter_filename+".csv");
		}
	}
	
	$(function() {
		$('#btnRight').click(function(e) {
			var selectedOpts = $('#lstBox1 option:selected');
			if(selectedOpts.length == 0) {
				alert("Select atleast one charecteristic from top to move.");
				e.preventDefault();
			}
			$('#lstBox2').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnAllRight').click(function(e) {
			var selectedOpts = $('#lstBox1 option');
			if(selectedOpts.length == 0) {
				alert("Moved already from top to bottom.");
				e.preventDefault();
			}
			$('#lstBox2').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnLeft').click(function(e) {
			var selectedOpts = $('#lstBox2 option:selected');
			if(selectedOpts.length == 0) {
				alert("Select atleast one charecteristic from bottom to move.");
				e.preventDefault();
			}
			$('#lstBox1').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#btnAllLeft').click(function(e) {
			var selectedOpts = $('#lstBox2 option');
			if(selectedOpts.length == 0) {
				alert("Moved already from bottom to top..");
				e.preventDefault();
			}
			$('#lstBox1').append($(selectedOpts).clone());
			$(selectedOpts).remove();
			e.preventDefault();
		});
		$('#save_bf').click(function(e) {
			var selectedOpts = $('#lstBox2 option');
			if(selectedOpts.length == 0) {
				alert("Move charecteristic into charecteristic order to do rearrange");
				e.preventDefault();
			}			
		});
	});

	/*function clickDownload(){
		window.open(filename, '_blank');
	}*/

	
	function masterCsv()
	{	
		document.getElementById("Trade_lbl").innerHTML = "Master Data";
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")	
		loadData("../html/Reports/"+foldername+"/IMP036_Delivery.csv");
	}
    
	$(document).ready(function () {
        var rect;
        if (self==top) {
            rect = document.body.getBoundingClientRect();
        }
        else {
            rect =  parent.document.body.getBoundingClientRect();
        }

        //Set display size based on window size.
        screenWidth = (rect.width < 960) ? Math.round(rect.width*.95) : Math.round((rect.width - 280) *.95);
        screenHeight=590;

        d3.select("#currentDisplay")
                .attr("item_value", (String(screenWidth) + "," + String(screenHeight)))
                .attr("class", "selected")
                .html("<a>" + screenWidth + "px - " + screenHeight + "px</a>");

        $("#cssmenu").menumaker({
            title: "FAULT MODEL",
            format: "multitoggle"
			//text-align: "center";
        });

        // Set the size of our container element.
        viz_container = d3.selectAll("#viz_container")
                .style("width", screenWidth + "px")
                .style("height", screenHeight + "px");

		//loadData();
		localStorage.setItem("IMP036_filename","IMP036_Delivery");
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")
        loadData("../html/Reports/"+foldername+"/IMP036_Delivery.csv");
	

    });
	
	
	function clickDownload(){
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")	
		var filename = "Reports/"+foldername+"/"+localStorage.getItem("IMP036_filename")+".csv";
		window.open(filename, '_blank');
	}
	
	function clickRearrangeDownload(){
		var dateTime = localStorage.getItem("dat");
		var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")+"/"+tradename+"_"+dateTime;
		
		var filename = "Reports/"+foldername+"/DeliveryWF_"+tradename+"_Rearrange.xlsx";
		window.open(filename, '_blank');
	}
		
	function clickDownload2(){	
	var foldername= localStorage.getItem("ipm_UserId") + "_"+ localStorage.getItem("reportname")
	tradename = $("#slt_trade option:selected").text()	
	var filename = "Reports/"+foldername+"/DeliverableWF_Master.xlsx";
	window.open(filename, '_blank');
	}
</script>

</body>
</html>